{% extends 'base.html' %}

{% block styles %}
    <!-- Include Leaflet and jQuery libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <!-- End of Leaflet and jQuery libraries -->
{% endblock %}

{% block map %}
<!-- Search bar container -->
<div class="search-container">
  <form method="POST">
    <input type="text" placeholder="Search for an address..." id="search-input">
    <button type="submit">Search</button>
  </form>
</div>

<!-- Map container -->
<div id="map"></div>

<!-- Rental information -->
<div class="rental-info">
  <h1>Seattle Rental Information</h1>
  <p>Click on a marker to view rental information.</p>
  <div class = "rental-data">
    <h1 id="rental-name"></h1>
    <h2 id="rental-address"></h2>
    <p><strong>Rating:</strong> <span id="rental-rating"></span></p>
    <p><strong>Phone:</strong> <span id="rental-phone"></span></p>
    <p><strong>Website:</strong> <span id="rental-website"></span></p>
  </div>
</div>

<!-- Marker details container -->
<div class="restaurant-details">
  <h1 id="restaurant-name"></h1>
  <h2 id="restaurant-address"></h2>
  <p><strong>Rating:</strong> <span id="restaurant-rating"></span></p>
  <p><strong>Phone:</strong> <span id="restaurant-phone"></span></p>
  <p><strong>Website:</strong> <span id="restaurant-website"></span></p>
</div>

<script>
// Sets the view and map object
const map = L.map('map').setView([47.60923991620634, -122.33245780856687], 13);

// Initiallizes the map with the given layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Load the JSON file and add markers for each feature
fetch('/markers')
  .then(response => response.json())
  .then(data => {
    data.features.forEach(feature => {
      var coordinates = feature.geometry.coordinates;
      console.log(coordinates);
      var id = feature.properties.id;
      console.log(id);
      var newMarker = L.marker(coordinates).addTo(map).on('click', function() {
        $.post("/", {
          marker_id: id
        });

        fetchMarkerPoints(id);
        rentalDetails(feature.properties);
        map.setView(coordinates, map.getZoom());

      });
    });
  });

let lastLayer;

// Function to fetch additional marker points
function fetchMarkerPoints(markerId) {
  if (lastLayer) {
    map.removeLayer(lastLayer);
    resetRestaurantDetails();
  }

  fetch(`/marker/${markerId}/points`)
  .then(response => response.json())
  .then(data => {
  var myIcon = L.icon({
    iconUrl: "{{ url_for('static', filename='marker-icon-red.png') }}",
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41] // Change the icon URL to the red marker icon
  });

  // Add the additional points to the Leaflet map
  lastLayer = L.geoJSON(data, {
    pointToLayer: function(feature, latlng) {
      return L.marker(latlng, {icon: myIcon}); // Use the custom icon for each marker
      
    },
    onEachFeature: function(feature, layer) {
      // Bind a popup to the marker with the feature properties
      layer.bindPopup("<b>Name:</b> " + feature.properties.name + "<br><b>Address:</b> " + feature.properties.address + "<br><b>Rating:</b> " + feature.properties.rating + "<br><b>Phone:</b> " + feature.properties.phone + "<br><b>Website:</b> " + feature.properties.website),
      console.log(feature.properties),
      // Add a click event listener to the marker
      layer.on('click', function(e) {
        restaurantDetails(feature.properties); // Run the updateTemplate function with the feature properties
        
      });

    }
  }).addTo(map);

})

.catch(error => {
  console.error('Error fetching marker points:', error);
  });
}

// Define the search form and search input elements
var searchForm = document.getElementById('search-form');
var searchInput = document.getElementById('search-input');

// Add an event listener to the search form to handle form submissions
searchForm.addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent the default form submission behavior

  // Get the search term from the search input field
  var search_term = searchInput.value;

  // Send an AJAX request to the Flask app to search for matching rentals
  fetch(`/search/${search_term}`)
    .then(response => response.json())
    .then(data => {
      var coordinates = data.features[0].geometry.coordinates;
      map.setView(coordinates, map.getZoom());
    });
});

// function search() {
//   // Get the search term from the search input field
//   var search_term = document.getElementById('search_term').value;

//   // Send an AJAX request to the Flask app to search for matching rentals
//   var xhr = new XMLHttpRequest();
//   xhr.open('GET', `/search/${search_term}`);
//   xhr.onload = function() {
//     if (xhr.status === 200) {
//       // Parse the GeoJSON feature collection from the response
//       var feature_collection = JSON.parse(xhr.responseText);

//       // Add the matching rentals to the Leaflet map as markers
//       var markers = L.geoJSON(feature_collection, {
//         onEachFeature: function(feature, layer) {
//           layer.bindPopup(`<b>${feature.properties.name}</b><br>${feature.properties.address}`);
//         }
//       }).addTo(map);

//       // Zoom the map to the extent of the matching rentals
//       map.fitBounds(markers.getBounds());
//     } else {
//       console.error('Error searching for rentals:', xhr.statusText);
//     }
//   };
//   xhr.onerror = function() {
//     console.error('Error searching for rentals:', xhr.statusText);
//   };
//   xhr.send();
// }

fetch(`/search/${searchTerm}`)
  .then(response => response.json())
  .then(data => {
      console.log(data.feature.geometry.coordinates);
      map.setView(data.feature.geometry.coordinates, map.getZoom());
      // var newMarker = L.marker(coordinates).addTo(map).on('click', function() {
      //   $.post("/", {
      //     marker_id: id
      //   });
      // function restaurantDetails(data) {
      //   console.log(data.address);
      //   // Update the HTML template with the marker details
      //   var element = document.getElementsByClassName("marker-details")[0];
      //   // Hide the element
      //   element.style.display = "block";

      //   var nameDiv = document.getElementById("name");
      //   // Update the name div with the name of the restaurant
      //   nameDiv.textContent = data.name;

      //   var addressDiv = document.getElementById("address");
      //   // Update the address div with the address of the restaurant
      //   addressDiv.textContent = data.address;

      //   var ratingDiv = document.getElementById("rating");
      //   // Update the rating div with the rating of the restaurant
      //   ratingDiv.textContent = data.rating;
      // }
    });

function restaurantDetails(restaurant) {
  // Update the marker-details div
  var element = document.getElementsByClassName("restaurant-details")[0];
  // Show the element
  element.style.display = "block";
  document.getElementById("restaurant-name").textContent = restaurant.name;
  document.getElementById("restaurant-address").textContent = restaurant.address;
  document.getElementById("restaurant-rating").textContent = restaurant.rating;
  document.getElementById("restaurant-phone").textContent = restaurant.phone;
  document.getElementById("restaurant-website").textContent = restaurant.website;
}

function resetRestaurantDetails() {
  // Update the marker-details div
  var element = document.getElementsByClassName("restaurant-details")[0];
  // Hide the element
  element.style.display = "none";
}

function rentalDetails(rental) {
  // Update the rental-info div
  var element = document.getElementsByClassName("rental-data")[0];
  // Show the element
  element.style.display = "block";
  document.getElementById("rental-name").textContent = rental.name;
  document.getElementById("rental-address").textContent = rental.address;
  document.getElementById("rental-rating").textContent = rental.rating;
  document.getElementById("rental-phone").textContent = rental.phone;
  document.getElementById("rental-website").textContent = rental.website;
}

// // Loop through the markers and add them to the map
// {% for point in features %}
//   addMarker({{ feature | tojson }});
// {% endfor %}

</script>
{% endblock %}