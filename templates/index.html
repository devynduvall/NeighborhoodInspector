{% extends 'base.html' %}

{% block styles %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
{% endblock %}



{% block map %}
<div class="search-container">
  <form action="/search" method="POST">
    <input type="text" placeholder="Search.." name="search_term">
    <button type="submit"><i class="fa fa-search"></i></button>
  </form>
</div>

  <div id="map"></div>

  <div class="marker-details"></div>
  <script>
    // Sets the view and map object
    const map = L.map('map').setView([47.60923991620634, -122.33245780856687], 13);

    // Initiallizes the map with the given layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function addMarker(id, lat, lon){
        // Add marker to map at click location; add popup window
        var newMarker = new L.marker([lat, lon]).addTo(map).on('click', function() {
          $.post("/", {
            marker_id: id
          });

          fetchMarkerPoints(id);

        });
      }

    let lastLayer;

    function fetchMarkerPoints(markerId) {
      if (lastLayer) {
        map.removeLayer(lastLayer);
      }
      
      fetch(`/marker/${markerId}/points`)
        .then(response => response.json())
        .then(data => {
            const layerStyle = {
            fillColor: 'red' // Change the color to red
          };

          // Add the additional points to the Leaflet map
          lastLayer = L.geoJSON(data, {
            style: layerStyle // Apply the style to the new layer
          }).addTo(map);

        })
        .catch(error => {
          console.error('Error fetching marker points:', error);
        });
    }


    function onMarkerSelected(markerId) {
      // Get the ID of the selected marker
      print(markerId)
      // Make an HTTP request to Flask to get updated data
      fetch('/marker-selected/' + markerId)
        .then(function(response) {
          return response;
        })
        .then(function(data) {
          console.log(data)
          // Update the HTML template with the updated data
          // (Assuming you have a function called "updateTemplate" that updates the HTML)
          // updateTemplate(data);
        });
    }

    function updateTemplate(data) {
      // Update the HTML template with the updated data
      // (Assuming you have a function called "updateTemplate" that updates the HTML)
      // updateTemplate(data);
    }

    {% for point in markers %}
      addMarker({{ point.id }}, {{ point.lat }}, {{ point.lon }}, "{{ point.name }}", "{{ point.address }}", "{{ point.rating }}", "{{ point.phone }}", "{{ point.website }}");
    {% endfor %}

  </script>
{% endblock %}


<!-- 
  function addMarker(id, lat, lon, name, address, rating, phone, website) {
  // Add marker to map at click location; add popup window
  var newMarker = new L.marker([lat, lon]).addTo(map).on('click', function() {
    $.post("/", {
      marker_id: id
    });

    // Update the HTML template with the marker details
    var markerDiv = document.createElement("div");
    markerDiv.className = "marker-details";

    var nameDiv = document.createElement("div");
    nameDiv.innerHTML = name;
    markerDiv.appendChild(nameDiv);

    var addressDiv = document.createElement("div");
    addressDiv.innerHTML = address;
    markerDiv.appendChild(addressDiv);

    var ratingDiv = document.createElement("div");
    ratingDiv.innerHTML = rating;
    markerDiv.appendChild(ratingDiv);

    var phoneDiv = document.createElement("div");
    phoneDiv.innerHTML = phone;
    markerDiv.appendChild(phoneDiv);

    var websiteDiv = document.createElement("div");
    websiteDiv.innerHTML = website;
    markerDiv.appendChild(websiteDiv);
  });
} -->