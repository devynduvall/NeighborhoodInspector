{% extends 'base.html' %}

{% block styles %}
    <!-- Include Leaflet and jQuery libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet">

    <!-- End of Leaflet and jQuery libraries -->
{% endblock %}

{% block map %}
<!-- Search bar container -->
<div class="search-container">
  <form action="/" method="POST">
    <input type="text" placeholder="Search for an address..." name="search_term">
    <button type="submit">Search</button>
  </form>
</div>

<!-- Map container -->
<div id="map"></div>

<!-- Rental information -->
<div class="rental-info">
  <h1>Seattle Rental Information</h1>
  <p>Click on a marker to view rental information.</p>
  <div class = "rental-data">
    <h1 id="rental-name"></h1>
    <h2 id="rental-address"></h2>
    <p><strong>Rating:</strong> <span id="rental-rating"></span></p>
    <p><strong>Phone:</strong> <span id="rental-phone"></span></p>
    <p><strong>Website:</strong> <span id="rental-website"></span></p>
  </div>
</div>

<!-- Marker details container -->
<div class="restaurant-details">
  <h1 id="restaurant-name"></h1>
  <h2 id="restaurant-address"></h2>
  <p><strong>Rating:</strong> <span id="restaurant-rating"></span></p>
  <p><strong>Phone:</strong> <span id="restaurant-phone"></span></p>
  <p><strong>Website:</strong> <span id="restaurant-website"></span></p>
</div>

<script>
// Sets the view and map object
mapboxgl.accessToken = 'pk.eyJ1IjoiZGR1dmFsbCIsImEiOiJja2xhZGNmaHIwMThrMnZtZDZidmxreXEzIn0.7GoqPq-DxGD00WE6CfmmTw';
var map = new mapboxgl.Map({
  container: 'map', // container ID
  // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
  style: 'mapbox://styles/mapbox/streets-v12', // style URL
  center: [-122.3321, 47.6062], // starting position [lng, lat]
  zoom: 9 // starting zoom
});

// Load the JSON file and add markers for each feature
fetch('/markers')
  .then(response => response.json())
  .then(data => {
    data.features.forEach(feature => {
      var coordinates = feature.geometry.coordinates;
      console.log(coordinates);
      var id = feature.properties.id;
      console.log(id);
      var newMarker = new mapboxgl.Marker({
        color: '#FF0000',
        interactive: true
      }).setLngLat(coordinates)
        .addTo(map);

      newMarker.getElement().addEventListener('click', function() {
        $.post("/", {
          marker_id: id
        });
        fetchMarkerPoints(id);
        rentalDetails(feature.properties);
        map.flyTo({
          center: coordinates,
          zoom: map.getZoom()
        });
      });
    });
  });

  
  map.on('load', function() {
    lastLayerId = null;
    lastSourceId = null;
    map.loadImage(
      'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
      function(error, image) {
        if (error) throw error;
        map.addImage('marker-15', image);
      }
    );
  });

  function fetchMarkerPoints(markerId) {
    fetch(`/marker/${markerId}/points`)
      .then(response => response.json())
      .then(data => {
        var features = data.features;
        var sourceData = {
          type: 'FeatureCollection',
          features: features
        };
        var newSourceId = `source-${markerId}`;
        var newLayerId = `layer-${markerId}`;
        var layer = {
          id: newLayerId,
          type: 'symbol',
          source: newSourceId,
          layout: {
            'icon-image': 'marker-15',
            'icon-allow-overlap': true,
            'icon-ignore-placement': true
          },
          paint: {
            'icon-color': '#FF0000'
          }
        };

        if (lastLayerId !== newLayerId) {
          if (lastLayerId) {
            map.removeLayer(lastLayerId);
            map.removeSource(lastSourceId);
            resetRestaurantDetails();
          }
          map.addSource(newSourceId, { type: 'geojson', data: sourceData });
          map.addLayer(layer);
          lastLayerId = newLayerId;
          lastSourceId = newSourceId;
        }
        rentalDetails(features[0].properties);


        map.on('click', newLayerId, function(e) {
          var clickedFeatures = map.queryRenderedFeatures(e.point, { layers: [newLayerId] });
          var selected = clickedFeatures.map(feature => feature.properties)
          console.log(selected)
          restaurantDetails(selected);
        });

        map.flyTo({
          center: features[0].geometry.coordinates,
          zoom: map.getZoom()
        });
      })
      .catch(error => {
        console.error('Error fetching marker points:', error);
      });
  }
  
// // Define the search form and search input elements
// var searchForm = document.getElementById('search-form');
// var searchInput = document.getElementById('search-input');

// // Add an event listener to the search form to handle form submissions
// searchForm.addEventListener('submit', function(event) {
//   event.preventDefault(); // Prevent the default form submission behavior

//   // Get the search term from the search input field
//   var search_term = rentals_search;

//   // Send an AJAX request to the Flask app to search for matching rentals
//   fetch(`/search/${search_term}`)
//     .then(response => response.json())
//     .then(data => {
//       var coordinates = data.features[0].geometry.coordinates;
//       map.setView(coordinates, map.getZoom());
//     });
// });

// function search() {
//   // Get the search term from the search input field
//   var search_term = document.getElementById('search_term').value;

//   // Send an AJAX request to the Flask app to search for matching rentals
//   var xhr = new XMLHttpRequest();
//   xhr.open('GET', `/search/${search_term}`);
//   xhr.onload = function() {
//     if (xhr.status === 200) {
//       // Parse the GeoJSON feature collection from the response
//       var feature_collection = JSON.parse(xhr.responseText);

//       // Add the matching rentals to the Leaflet map as markers
//       var markers = L.geoJSON(feature_collection, {
//         onEachFeature: function(feature, layer) {
//           layer.bindPopup(`<b>${feature.properties.name}</b><br>${feature.properties.address}`);
//         }
//       }).addTo(map);

//       // Zoom the map to the extent of the matching rentals
//       map.fitBounds(markers.getBounds());
//     } else {
//       console.error('Error searching for rentals:', xhr.statusText);
//     }
//   };
//   xhr.onerror = function() {
//     console.error('Error searching for rentals:', xhr.statusText);
//   };
//   xhr.send();
// }

// searchForm.addEventListener('submit', function(event) {
//   event.preventDefault(); // Prevent the form from submitting normally
//   search(); // Call the search() function to perform the search
// });


// function search() {
//   fetch(`/search`)
//   .then(response => response.json())
//   .then(data => {
//       console.log(data.feature.geometry.coordinates);
//       map.setView(data.feature.geometry.coordinates, map.getZoom());
//     });
// }

      // var newMarker = L.marker(coordinates).addTo(map).on('click', function() {
      //   $.post("/", {
      //     marker_id: id
      //   });
      // function restaurantDetails(data) {
      //   console.log(data.address);
      //   // Update the HTML template with the marker details
      //   var element = document.getElementsByClassName("marker-details")[0];
      //   // Hide the element
      //   element.style.display = "block";

      //   var nameDiv = document.getElementById("name");
      //   // Update the name div with the name of the restaurant
      //   nameDiv.textContent = data.name;

      //   var addressDiv = document.getElementById("address");
      //   // Update the address div with the address of the restaurant
      //   addressDiv.textContent = data.address;

      //   var ratingDiv = document.getElementById("rating");
      //   // Update the rating div with the rating of the restaurant
      //   ratingDiv.textContent = data.rating;
      // }

function restaurantDetails(restaurant) {
  console.log(restaurant);
  restaurant = restaurant[0];
  // Update the marker-details div
  var element = document.getElementsByClassName("restaurant-details")[0];
  // Show the element
  element.style.display = "block";
  document.getElementById("restaurant-name").textContent = restaurant.name;
  document.getElementById("restaurant-address").textContent = restaurant.address;
  document.getElementById("restaurant-rating").textContent = restaurant.rating;
  document.getElementById("restaurant-phone").textContent = restaurant.phone;
  document.getElementById("restaurant-website").textContent = restaurant.website;
}

function resetRestaurantDetails() {
  // Update the marker-details div
  var element = document.getElementsByClassName("restaurant-details")[0];
  // Hide the element
  element.style.display = "none";
}

function rentalDetails(rental) {
  // Update the rental-info div
  var element = document.getElementsByClassName("rental-data")[0];
  // Show the element
  element.style.display = "block";
  document.getElementById("rental-name").textContent = rental.name;
  document.getElementById("rental-address").textContent = rental.address;
  document.getElementById("rental-rating").textContent = rental.rating;
  document.getElementById("rental-phone").textContent = rental.phone;
  document.getElementById("rental-website").textContent = rental.website;
}

// // Loop through the markers and add them to the map
// {% for point in features %}
//   addMarker({{ feature | tojson }});
// {% endfor %}

</script>
{% endblock %}